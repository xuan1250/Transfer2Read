<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>4</storyId>
    <title>Password Reset & User Profile</title>
    <status>done</status>
    <generatedAt>2025-12-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-4-password-reset-user-profile.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>User</asA>
    <iWant>to reset my forgotten password and view my profile</iWant>
    <soThat>I can manage my account security</soThat>
    <tasks>
      <task id="1" ac="#1">Create Forgot Password Page</task>
      <task id="2" ac="#2">Create Reset Password Page</task>
      <task id="3" ac="#3">Create User Profile/Settings Page</task>
      <task id="4" ac="#3">Add Change Password form to Settings</task>
      <task id="5" ac="#3">Add Delete Account functionality</task>
      <task id="6" ac="All">Style and UX polish</task>
      <task id="7">Add Navigation to Settings Page</task>
      <task id="8" ac="All">Testing and validation</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">
      <title>Forgot Password Flow</title>
      <details>
        - "Forgot Password" link on /login opens /forgot-password page
        - User enters email → Calls supabase.auth.resetPasswordForEmail()
        - Supabase sends password reset email with magic link
        - User clicks link → Redirected to /reset-password with token
      </details>
    </criterion>
    <criterion id="2">
      <title>Reset Password Page</title>
      <details>
        - Form accepts new password (with strength validation)
        - Submit calls supabase.auth.updateUser({ password: newPassword })
        - Success redirects to /login with confirmation message
      </details>
    </criterion>
    <criterion id="3">
      <title>User Profile Page (/settings)</title>
      <details>
        - Displays user email (read-only)
        - Displays current tier (FREE/PRO/PREMIUM)
        - "Change Password" form (for email/password users only)
        - "Delete Account" button (confirmation dialog)
      </details>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: User Identity & Account Management</title>
        <section>Password Reset Flow</section>
        <snippet>User clicks "Forgot Password" → enters email on /forgot-password → Frontend calls supabase.auth.resetPasswordForEmail() → Supabase sends magic link → User clicks link → /reset-password with token → new password → supabase.auth.updateUser() → redirect to /login</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: User Identity & Account Management</title>
        <section>Data Models - User Metadata</section>
        <snippet>Supabase auth.users.raw_user_meta_data stores tier (FREE/PRO/PREMIUM, default FREE), created_at, updated_at. Authentication provider in auth.users.app_metadata.provider (email, google, github).</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-2.md</path>
        <title>Epic Technical Specification: User Identity & Account Management</title>
        <section>Frontend Auth Actions</section>
        <snippet>Reset Password Request: supabase.auth.resetPasswordForEmail(email), Update Password: supabase.auth.updateUser({ password }), Get User: supabase.auth.getUser() via useUser hook</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Security</title>
        <section>Security Architecture</section>
        <snippet>Supabase Auth with JWT tokens, managed sessions, secure cookies. Row Level Security (RLS) policies ensure users only access own data. Password hashing via bcrypt (Supabase managed).</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Visual Foundation - Professional Blue Theme</section>
        <snippet>Primary: #2563eb, Success: #10b981, Error: #ef4444. System fonts for fast loading. shadcn/ui components (Card, Input, Button, AlertDialog, Badge, Toast) for consistent UI.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Transfer2Read - Epic and Story Breakdown</title>
        <section>Story 2.4: Password Reset & User Profile</section>
        <snippet>Three acceptance criteria: (1) Forgot Password flow with magic link, (2) Reset Password page with strength validation, (3) User Profile at /settings showing email, tier, change password form (email users only), delete account button with confirmation.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>frontend/src/lib/supabase/client.ts</path>
        <kind>client</kind>
        <symbol>createClient</symbol>
        <lines>8-13</lines>
        <reason>Supabase browser client factory used for auth operations (resetPasswordForEmail, updateUser)</reason>
      </file>
      <file>
        <path>frontend/src/hooks/useUser.ts</path>
        <kind>hook</kind>
        <symbol>useUser</symbol>
        <lines>29-77</lines>
        <reason>React hook providing current user state, loading, and signOut function - used in Settings page to display profile data</reason>
      </file>
      <file>
        <path>frontend/src/components/auth/AuthGuard.tsx</path>
        <kind>component</kind>
        <symbol>AuthGuard</symbol>
        <lines>29-60</lines>
        <reason>HOC for protecting routes - wrap Settings page to require authentication</reason>
      </file>
      <file>
        <path>frontend/src/components/auth/PasswordStrengthIndicator.tsx</path>
        <kind>component</kind>
        <symbol>PasswordStrengthIndicator</symbol>
        <lines>23-91</lines>
        <reason>Reusable password strength validator with visual indicator - use in Reset Password and Change Password forms</reason>
      </file>
      <file>
        <path>frontend/src/app/login/page.tsx</path>
        <kind>page</kind>
        <symbol>LoginPage</symbol>
        <lines>156-163</lines>
        <reason>Add "Forgot Password?" link already exists at lines 156-163 - verify placement</reason>
      </file>
      <file>
        <path>frontend/src/components/layout/TopBar.tsx</path>
        <kind>component</kind>
        <symbol>TopBar</symbol>
        <lines>14-16</lines>
        <reason>Modify to add Settings navigation with user dropdown menu (currently static buttons)</reason>
      </file>
      <file>
        <path>backend/app/core/auth.py</path>
        <kind>middleware</kind>
        <symbol>get_current_user</symbol>
        <lines>18-83</lines>
        <reason>FastAPI dependency for JWT validation - reference for understanding auth flow, though password reset is handled by Supabase</reason>
      </file>
    </code>
    <dependencies>
      <frontend>
        <package name="@supabase/supabase-js" version="^2.86.0">Supabase client for auth.resetPasswordForEmail() and auth.updateUser()</package>
        <package name="react-hook-form" version="^7.68.0">Form state management for password reset and settings forms</package>
        <package name="zod" version="^4.1.13">Schema validation for password strength requirements</package>
        <package name="@hookform/resolvers" version="^5.2.2">Zod resolver for react-hook-form integration</package>
        <package name="lucide-react" version="^0.555.0">Icons for UI (settings icon, delete icon, checkmarks)</package>
      </frontend>
      <shadcn_ui>
        <component>Card</component>
        <component>Input</component>
        <component>Button</component>
        <component>Label</component>
        <component>AlertDialog</component>
        <component>Badge</component>
        <component>Toast</component>
        <component>Skeleton</component>
      </shadcn_ui>
    </dependencies>
  </artifacts>

  <constraints>
    <architecture>
      <constraint>All password reset logic handled by Supabase Auth - no custom backend endpoints required</constraint>
      <constraint>User metadata (tier, provider) stored in Supabase auth.users.raw_user_meta_data and app_metadata</constraint>
      <constraint>Professional Blue theme: Primary #2563eb, Success #10b981, Error #ef4444</constraint>
      <constraint>Use shadcn/ui components consistently - no custom UI primitives</constraint>
      <constraint>System fonts only (no web fonts) - fast loading per architecture</constraint>
    </architecture>
    <security>
      <constraint>Password strength: min 8 chars, 1 uppercase, 1 lowercase, 1 number (Zod validation)</constraint>
      <constraint>Email confirmation required for account deletion to prevent accidents</constraint>
      <constraint>Password reset tokens managed by Supabase (secure, time-limited)</constraint>
      <constraint>Current password verification for password change (reauthentication if needed)</constraint>
      <constraint>All auth operations use HTTPS via Supabase (enforced by platform)</constraint>
    </security>
    <ux_patterns>
      <constraint>Follow existing login page pattern: Card layout, Zod + react-hook-form, error handling</constraint>
      <constraint>Reuse PasswordStrengthIndicator component from Story 2.2 (already exists)</constraint>
      <constraint>Settings page must be protected with AuthGuard HOC</constraint>
      <constraint>Change Password form only visible for email/password users (hide for OAuth users)</constraint>
      <constraint>Delete account requires confirmation dialog (AlertDialog) with email match validation</constraint>
    </ux_patterns>
    <testing>
      <constraint>Manual E2E testing required for email flows (Supabase sends actual emails)</constraint>
      <constraint>Build validation: npm run build must pass with no TypeScript errors</constraint>
      <constraint>Linting: npm run lint must pass</constraint>
    </testing>
  </constraints>
  <interfaces>
    <supabase_auth>
      <method>
        <name>supabase.auth.resetPasswordForEmail</name>
        <signature>resetPasswordForEmail(email: string, options?: { redirectTo?: string }): Promise&lt;AuthResponse&gt;</signature>
        <usage>Forgot Password page - sends magic link email</usage>
      </method>
      <method>
        <name>supabase.auth.updateUser</name>
        <signature>updateUser(attributes: { password?: string }): Promise&lt;UserResponse&gt;</signature>
        <usage>Reset Password page and Change Password form - updates user password</usage>
      </method>
      <method>
        <name>supabase.auth.getUser</name>
        <signature>getUser(): Promise&lt;UserResponse&gt;</signature>
        <usage>Settings page - fetch current user data via useUser hook</usage>
      </method>
    </supabase_auth>
    <user_metadata>
      <interface>
        <name>User.user_metadata</name>
        <fields>
          <field name="tier" type="'FREE' | 'PRO' | 'PREMIUM'">Subscription tier from raw_user_meta_data</field>
          <field name="created_at" type="string">ISO timestamp</field>
        </fields>
      </interface>
      <interface>
        <name>User.app_metadata</name>
        <fields>
          <field name="provider" type="'email' | 'google' | 'github'">Authentication provider</field>
        </fields>
      </interface>
    </user_metadata>
    <react_hook_form>
      <schema>
        <name>passwordResetSchema</name>
        <definition>z.object({ password: z.string().min(8).regex(/[A-Z]/).regex(/[a-z]/).regex(/[0-9]/), confirmPassword: z.string() }).refine((data) =&gt; data.password === data.confirmPassword, { message: "Passwords must match" })</definition>
      </schema>
    </react_hook_form>
  </interfaces>
  <tests>
    <standards>
      Frontend testing follows Vitest + React Testing Library pattern per architecture. Component tests for form validation (Zod schemas), user interactions, and conditional rendering. Manual E2E testing for complete auth flows involving Supabase email delivery. Build and lint validation required before story completion (npm run build, npm run lint must pass with no errors).
    </standards>
    <locations>
      <pattern>frontend/src/components/**/*.test.tsx</pattern>
      <pattern>frontend/src/app/**/*.test.tsx</pattern>
      <note>Colocate tests with components per architecture pattern</note>
    </locations>
    <ideas>
      <test ac="1">
        <description>Forgot Password form submission</description>
        <approach>Component test: render /forgot-password, enter email, submit, verify supabase.auth.resetPasswordForEmail called with correct email and redirectTo parameter</approach>
      </test>
      <test ac="2">
        <description>Reset Password with strength validation</description>
        <approach>Unit test PasswordStrengthIndicator: weak password shows red bar, strong password shows green. Component test: submit weak password → validation error, submit strong password → supabase.auth.updateUser called</approach>
      </test>
      <test ac="3">
        <description>Settings page displays user profile</description>
        <approach>Component test: mock useUser hook with email/password user → verify email displayed, tier badge shown, change password form visible. Mock OAuth user → verify provider message, no password form</approach>
      </test>
      <test ac="3">
        <description>Delete account confirmation</description>
        <approach>Component test: click Delete Account → AlertDialog appears, enter wrong email → button disabled, enter correct email → delete handler called</approach>
      </test>
      <test id="manual-e2e-1">
        <description>Complete password reset flow with email</description>
        <approach>Manual: Submit forgot password → check inbox → click magic link → verify redirect to /reset-password with token → set new password → verify redirect to /login → login with new password → success</approach>
      </test>
      <test id="manual-e2e-2">
        <description>Change password for email user</description>
        <approach>Manual: Login with email/password → navigate to Settings → change password → verify success → logout → login with new password → success</approach>
      </test>
    </ideas>
  </tests>
</story-context>
