<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.5</storyId>
    <title>Vercel + Railway Deployment Configuration</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-04</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-vercel-railway-deployment-configuration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>DevOps Engineer</asA>
    <iWant>to configure deployment to Vercel (frontend) and Railway (backend + workers)</iWant>
    <soThat>the application is production-ready with managed Supabase services</soThat>
    <tasks>
- Task 1: Create Production Supabase Project (AC: #3)
- Task 2: Set up Vercel Frontend Deployment (AC: #1)
- Task 3: Set up Railway Backend Services (AC: #2, #6)
- Task 4: Configure CORS for Production (AC: #4)
- Task 5: Verify Production Deployment (AC: #5)
- Task 6: Set up CI/CD with GitHub Actions (AC: #7)
- Task 7: Create Deployment Documentation (AC: ALL)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Vercel Project: Frontend connected to GitHub repo with Production and Preview environments, environment variables configured
2. Railway Project: API Service, Worker Service, and managed Redis deployed with environment variables
3. Supabase Production: Production Supabase project (separate from dev)
4. CORS Configuration: Backend allows Vercel production domain
5. Health Check: Public URLs accessible (frontend and backend /api/health → 200 OK)
6. Secrets Management: All API keys stored in Railway secrets (not committed)
7. CI/CD: GitHub Actions runs tests on PR before deployment
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Deployment Architecture</section>
        <snippet>Frontend deployed to Vercel (Edge Network), Backend API + Worker deployed to Railway (Containers), Redis managed on Railway, Database/Auth/Storage fully managed by Supabase. Zero-downtime deployment via Railway blue-green strategy.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Environment Configuration</section>
        <snippet>Frontend env vars: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY, NEXT_PUBLIC_API_URL. Backend env vars: SUPABASE_URL, SUPABASE_SERVICE_KEY, OPENAI_API_KEY, ANTHROPIC_API_KEY, REDIS_URL.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>ADR-002: Supabase as Unified Backend Platform</section>
        <snippet>Use Supabase for authentication, database, and file storage. Production project should be separate from development for security and data isolation.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic and Story Breakdown</title>
        <section>Story 1.5: Vercel + Railway Deployment Configuration</section>
        <snippet>Configure deployment to Vercel (frontend) and Railway (backend + workers) with managed Supabase services. Includes CORS configuration, health checks, secrets management, and CI/CD pipeline.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-1.md</path>
        <title>Epic 1 Technical Specification</title>
        <section>Story 1.5: Deployment Pipeline Configuration</section>
        <snippet>Vercel auto-deploys frontend from GitHub main branch. Railway auto-deploys backend and worker containers. GitHub Actions runs tests on PR. All secrets stored in platform secret managers.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/1-4-celery-worker-ai-sdk-setup.md</path>
        <title>Previous Story: Celery Worker & AI SDK Setup</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>Worker entrypoint created at backend/app/worker.py with comprehensive startup logging. Docker Compose worker service configured with environment variable mounts. Worker successfully processes test AI tasks.</snippet>
      </doc>
    </docs>
    
    <code>
      <artifact>
        <path>backend/app/main.py</path>
        <kind>application_entry</kind>
        <symbol>app (FastAPI instance)</symbol>
        <lines>1-50</lines>
        <reason>Contains CORS middleware configuration that needs to be updated to include Vercel production domain</reason>
      </artifact>
      <artifact>
        <path>backend/app/core/config.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>1-50</lines>
        <reason>Defines all environment variables needed for deployment (Supabase, Redis, AI API keys) - reference for Railway environment configuration</reason>
      </artifact>
      <artifact>
        <path>backend/app/api/health.py</path>
        <kind>api_endpoint</kind>
        <symbol>health_check</symbol>
        <lines>1-30</lines>
        <reason>Health check endpoint to verify in production deployment - should return Supabase and Redis connection status</reason>
      </artifact>
      <artifact>
        <path>backend/app/worker.py</path>
        <kind>worker_entry</kind>
        <symbol>celery_app</symbol>
        <lines>1-50</lines>
        <reason>Worker entrypoint for Railway Worker service - use same command as Docker Compose</reason>
      </artifact>
      <artifact>
        <path>backend/app/core/celery_app.py</path>
        <kind>configuration</kind>
        <symbol>celery_app</symbol>
        <lines>1-40</lines>
        <reason>Celery configuration that will be used in production with Railway managed Redis</reason>
      </artifact>
      <artifact>
        <path>docker-compose.yml</path>
        <kind>deployment_config</kind>
        <symbol>worker service</symbol>
        <lines>19-36</lines>
        <reason>Reference pattern for Worker service deployment to Railway - command and environment variables</reason>
      </artifact>
      <artifact>
        <path>frontend/package.json</path>
        <kind>config</kind>
        <symbol>build script</symbol>
        <lines>5-9</lines>
        <reason>Vercel uses 'npm run build' script for deployment</reason>
      </artifact>
      <artifact>
        <path>backend/requirements.txt</path>
        <kind>dependencies</kind>
        <symbol>N/A</symbol>
        <lines>1-41</lines>
        <reason>Python dependencies needed for Dockerfile and Railway deployment</reason>
      </artifact>
    </code>
    
    <dependencies>
      <python>
        <package name="fastapi" version="0.122.0" />
        <package name="uvicorn[standard]" version="0.30.0" />
        <package name="celery" version="5.5.3" />
        <package name="redis" version="5.0.1" />
        <package name="supabase" version="2.24.0" />
        <package name="langchain" version="~0.3.0" />
        <package name="langchain-openai" version="~0.2.0" />
        <package name="langchain-anthropic" version="~0.3.0" />
        <package name="pymupdf" version="1.24.10" />
        <package name="sqlalchemy" version="2.0.36" />
        <package name="pydantic" version=">=2.11.7,<3.0.0" />
      </python>
      <node>
        <package name="next" version="15.0.3" />
        <package name="react" version="19.0.0-rc-66855b96-20241106" />
        <package name="@supabase/supabase-js" version="^2.86.0" />
        <package name="@supabase/auth-helpers-nextjs" version="^0.15.0" />
        <package name="@supabase/ssr" version="^0.8.0" />
        <package name="typescript" version="^5" />
        <package name="tailwindcss" version="^3.4.1" />
      </node>
      <system>
        <package name="Docker" version="Required for Dockerfile build" />
        <package name="Redis" version="8.4.0 (Railway managed)" />
        <package name="Python" version="3.12.9 (for Dockerfile base image)" />
        <package name="Node.js" version="24.x (Vercel runtime)" />
      </system>
    </dependencies>
  </artifacts>

  <constraints>
- **Dockerfile Creation Required:** Must create backend/Dockerfile using Python 3.12.9 base image (consistent with Stories 1.2-1.4)
- **Environment Variable Security:** Never commit real credentials. Use .env.example with placeholders only. Store production secrets in Railway/Vercel platform secret managers
- **CORS Configuration:** Must add Vercel production domain to backend CORS allowed origins (currently only localhost configured)
- **Railway Service Dependencies:** Worker service depends on Redis service - Railway manages startup order automatically
- **Port Configuration:** Railway provides $PORT environment variable - backend must use it for API service
- **Docker Command Separation:** API and Worker use same Dockerfile but different start commands (uvicorn vs celery)
- **Supabase Production Separation:** Production Supabase project must be separate from development for security
- **Health Check Verification:** Backend health endpoint must return Supabase and Redis connection status for deployment verification
- **CI/CD Test Requirements:** GitHub Actions must run pytest (backend) and npm test (frontend) before allowing merge
- **Deployment Documentation:** Must update README.md with production URLs, environment variable requirements, and troubleshooting guide
- **Python Version Consistency:** Use Python 3.12.9 in Dockerfile (matches Stories 1.2-1.4, not 3.13.0 spec)
  </constraints>

  <interfaces>
    <interface>
      <name>Backend Health Check</name>
      <kind>REST endpoint</kind>
      <signature>GET /api/health → 200 OK { "status": "healthy", "database": "connected", "redis": "connected", "timestamp": "ISO-8601" }</signature>
      <path>backend/app/api/health.py</path>
    </interface>
    <interface>
      <name>Vercel Deployment API</name>
      <kind>Platform API</kind>
      <signature>GitHub integration triggers automatic deployment on push to main. Environment variables configured via Vercel dashboard.</signature>
      <path>N/A - External platform</path>
    </interface>
    <interface>
      <name>Railway Deployment API</name>
      <kind>Platform API</kind>
      <signature>GitHub integration triggers automatic deployment. Services defined via Railway dashboard. Environment variables configured per service.</signature>
      <path>N/A - External platform</path>
    </interface>
    <interface>
      <name>Supabase Production API</name>
      <kind>Backend service</kind>
      <signature>SUPABASE_URL (project URL), SUPABASE_SERVICE_KEY (admin operations), SUPABASE_ANON_KEY (client operations)</signature>
      <path>N/A - External managed service</path>
    </interface>
    <interface>
      <name>GitHub Actions CI/CD</name>
      <kind>Workflow automation</kind>
      <signature>Triggered on pull_request and push to main. Runs backend tests (pytest) and frontend tests (npm test). Auto-deploys on success.</signature>
      <path>.github/workflows/ci.yml (to be created)</path>
    </interface>
    <interface>
      <name>Railway Redis</name>
      <kind>Managed service</kind>
      <signature>Internal connection URL auto-provided as environment variable. Used for CELERY_BROKER_URL and CELERY_RESULT_BACKEND.</signature>
      <path>N/A - Railway managed</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Backend testing uses pytest with coverage. Frontend testing currently minimal (npm test script exists but no tests configured). Deployment verification requires manual testing of health endpoint and frontend-backend connectivity. Integration tests verify Supabase and Redis connections. CI/CD pipeline will run automated tests before deployment.
    </standards>
    
    <locations>
- backend/tests/ - Backend test suite
- backend/tests/integration/test_health.py - Health endpoint tests
- frontend/ - Frontend tests (to be configured)
- .github/workflows/ci.yml - CI/CD test automation (to be created)
    </locations>
    
    <ideas>
- **AC1 (Vercel Project):** Manual verification - Visit Vercel URL, check environment variables in dashboard, verify preview deployments work on PR
- **AC2 (Railway Services):** Manual verification - Check Railway dashboard for 3 services (API, Worker, Redis), verify logs show successful startup
- **AC3 (Supabase Production):** Manual verification - Create production project in Supabase dashboard, verify storage buckets and auth provider configured
- **AC4 (CORS Configuration):** Integration test - Frontend calls backend health endpoint from Vercel URL, verify no CORS errors in browser console
- **AC5 (Health Check):** Integration test - GET request to Railway API URL /api/health, assert 200 OK and valid JSON response with connection status
- **AC6 (Secrets Management):** Code review - Verify .env not committed, verify .env.example has placeholders only, verify Railway secrets configured
- **AC7 (CI/CD):** Integration test - Create test PR, verify GitHub Actions runs, verify tests execute, verify deployment triggers on merge to main
- **Dockerfile Test:** Build Docker image locally, run container, verify uvicorn starts and health endpoint responds
- **Worker Deployment Test:** Check Railway Worker logs for Celery startup messages and task registration
- **End-to-End Test:** Upload test file via frontend → Verify backend receives request → Verify worker processes task (manual for now)
    </ideas>
  </tests>
</story-context>
